<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Canh giờ Boss Lineage2M</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #121212;
      color: #f0f0f0;
      margin: 0;
      padding: 20px;
    }
    h1 {
      text-align: center;
      margin-bottom: 20px;
    }
    .search-wrapper {
      display: flex;
      justify-content: center;
      margin-bottom: 16px;
    }
    .search-box {
      position: relative;
      width: 300px;
    }
    #searchInput {
      width: 100%;
      padding: 8px 30px 8px 10px;
      border-radius: 6px;
      border: 1px solid #444;
      background-color: #222;
      color: #fff;
    }
    .clear-btn {
      position: absolute;
      right: 6px;
      top: 50%;
      transform: translateY(-50%);
      cursor: pointer;
      font-size: 20px;
      background: none;
      border: none;
      color: #aaa;
      padding: 0;
      line-height: 1;
    }
    .clear-btn:hover {
      color: #fff;
    }
    .boss-list {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 16px;
    }
    .boss-card {
      background-color: #1e1e1e;
      padding: 16px;
      border-radius: 12px;
      box-shadow: 0 0 10px rgba(0,0,0,0.5);
      transition: 0.3s ease;
    }
    .boss-card:hover {
      box-shadow: 0 0 15px rgba(255,255,255,0.1);
    }
    .boss-title {
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 8px;
    }
    .boss-info {
      font-size: 14px;
      margin-bottom: 6px;
    }
    .label {
      color: #aaa;
    }
    input[type="datetime-local"] {
      background-color: #222;
      color: #f0f0f0;
      border: 1px solid #444;
      padding: 4px;
      border-radius: 6px;
    }
    .next-respawn {
      margin-top: 4px;
      font-weight: bold;
      color: #0f0;
    }
    .log-toggle, .copy-log {
      margin-top: 6px;
      font-size: 13px;
      background-color: #2a2a2a;
      color: #ccc;
      border: none;
      border-radius: 4px;
      padding: 4px 8px;
      cursor: pointer;
      margin-right: 6px;
    }
    .log-box {
      display: none;
      margin-top: 6px;
      background-color: #191919;
      padding: 6px;
      border-radius: 6px;
      font-size: 12px;
      white-space: pre-line;
      color: #ccc;
    }
  </style>
</head>
<body>
  <h1>Canh Giờ Boss Lineage2M</h1>
  <div style="position: relative; width: 100%; max-width: 400px; margin: 0 auto 20px;">
    <input type="text" id="searchInput" placeholder="Tìm tên boss, zone hoặc vị trí..." class="search-box" />
    <button onclick="clearSearch()" class="clear-btn">×</button>
  </div>
  <div id="bossList" class="boss-list"></div>

  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-database-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCuQp6U8LMb5OZmtEjVmL_iMLPoDvcOSlE",
      authDomain: "boss-timing.firebaseapp.com",
      databaseURL: "https://boss-timing-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "boss-timing",
      storageBucket: "boss-timing.appspot.com",
      messagingSenderId: "1094091313294",
      appId: "1:1094091313294:web:da1c91824c3167cebd1a1b"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const killedOffsetMap = level => {
      if (level >= 70) return 30;
      if (level >= 60) return 20;
      if (level >= 50) return 10;
      return 5;
    };

    function formatTime(date) {
      return new Date(date).toLocaleString("vi-VN", { hour12: false });
    }

    let allBosses = {};

    function renderBossList(bosses) {
      const container = document.getElementById("bossList");
      container.innerHTML = "";
      Object.entries(bosses).forEach(([id, boss]) => {
        const card = document.createElement("div");
        card.className = "boss-card";
        card.setAttribute("data-name", boss.name);
        card.setAttribute("data-location", boss.location);
        card.setAttribute("data-zone", boss.zone);

        const inputId = `input-${id}`;
        const timeId = `time-${id}`;
        const logId = `log-${id}`;
        const toggleId = `toggle-${id}`;
        const copyId = `copy-${id}`;

        card.innerHTML = `
          <div class="boss-title">${boss.name}</div>
          <div class="boss-info"><span class="label">Zone:</span> ${boss.zone}</div>
          <div class="boss-info"><span class="label">Location:</span> ${boss.location}</div>
          <div class="boss-info"><span class="label">Level:</span> ${boss.level}</div>
          <div class="boss-info"><span class="label">Respawn:</span> ${boss.respawn} giờ</div>
          <div class="boss-info">
            <span class="label">Nhập thời gian bị tiêu diệt:</span><br>
            <input type="datetime-local" id="${inputId}">
          </div>
          <div class="next-respawn" id="${timeId}">Next Respawn: --</div>
          <button class="log-toggle" id="${toggleId}">Xem lịch sử</button>
          <button class="copy-log" onclick="copyLog('${id}')">COPY LOG</button>
          <div class="log-box" id="${logId}"></div>
        `;

        container.appendChild(card);

        const inputEl = document.getElementById(inputId);
        const timeEl = document.getElementById(timeId);
        const logEl = document.getElementById(logId);
        const toggleBtn = document.getElementById(toggleId);

        let killedTime = null;
        let nextRespawn = null;
        const logs = [];

        inputEl.addEventListener("change", () => {
          killedTime = new Date(inputEl.value);
          const offsetMin = killedOffsetMap(boss.level);
          const respawnMs = boss.respawn * 60 * 60 * 1000;
          const offsetMs = offsetMin * 60 * 1000;
          nextRespawn = new Date(killedTime.getTime() + respawnMs);
          timeEl.innerText = `Next Respawn: ${formatTime(nextRespawn)}`;
          logs.unshift(`• Kill: ${formatTime(killedTime)}\n  → Respawn: ${formatTime(nextRespawn)}\n• [RAW] ${nextRespawn.toISOString()}`);
          logEl.textContent = logs.join("\n\n");
        });

        toggleBtn.onclick = () => {
          logEl.style.display = logEl.style.display === "block" ? "none" : "block";
          toggleBtn.innerText = logEl.style.display === "block" ? "Ẩn lịch sử" : "Xem lịch sử";
        };

        setInterval(() => {
          if (!nextRespawn || !killedTime) return;
          const now = new Date();
          const offsetMin = killedOffsetMap(boss.level);
          const respawnMs = boss.respawn * 60 * 60 * 1000;
          const offsetMs = offsetMin * 60 * 1000;

          if (now.getTime() >= nextRespawn.getTime() + offsetMs) {
            killedTime = new Date(nextRespawn.getTime() + offsetMs);
            nextRespawn = new Date(killedTime.getTime() + respawnMs);
            timeEl.innerText = `Next Respawn: ${formatTime(nextRespawn)}`;
            logs.unshift(`• Auto Kill: ${formatTime(killedTime)}\n  → Respawn: ${formatTime(nextRespawn)}\n• [RAW] ${nextRespawn.toISOString()}`);
            logEl.textContent = logs.join("\n\n");
          }
        }, 1000);
      });
    }

    db.ref("bosses").once("value").then(snapshot => {
      const data = snapshot.val();
      if (data) {
        allBosses = data;
        renderBossList(data);
      }
    });

    document.getElementById("searchInput").addEventListener("input", e => {
      const keyword = e.target.value.trim().toLowerCase();
      const bossCards = document.querySelectorAll(".boss-card");
      bossCards.forEach(card => {
        const name = card.getAttribute("data-name").toLowerCase();
        const location = card.getAttribute("data-location").toLowerCase();
        const zone = card.getAttribute("data-zone").toLowerCase();

        if (
          name.includes(keyword) ||
          location.includes(keyword) ||
          zone.includes(keyword)
        ) {
          card.style.display = "block";
        } else {
          card.style.display = "none";
        }
      });
    });

    function clearSearch() {
      const input = document.getElementById('searchInput');
      input.value = '';
      document.querySelectorAll(".boss-card").forEach(card => {
        card.style.display = "block";
      });
    }

    function copyLog(id) {
      const boss = allBosses[id];
      const logBox = document.getElementById(`log-${id}`);
      const rawLine = (logBox.textContent.trim().split("\n").find(l => l.startsWith("• [RAW]")) || "").replace("• [RAW] ", "");

      if (!rawLine) return alert("Không lấy được thời gian respawn!");
      const date = new Date(rawLine);
      if (isNaN(date.getTime())) return alert("Thời gian không hợp lệ!");

      const hour = date.getHours().toString().padStart(2, "0");
      const minute = date.getMinutes().toString().padStart(2, "0");
      const day = date.getDate();
      const month = date.getMonth() + 1;
      const result = `${boss.name} | ${boss.location} | ${hour}:${minute} ${day}/${month}`;

      navigator.clipboard.writeText(result).then(() => alert("✅ Đã sao chép log!"));
    }
  </script>
</body>
</html>

