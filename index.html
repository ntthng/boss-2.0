<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Canh giờ Boss - Lineage2M</title>
  <style>
    body { font-family: Arial, sans-serif; background: #111; color: #eee; padding: 20px; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #444; padding: 6px; text-align: left; }
    input[type="datetime-local"] { background: #222; color: #fff; border: 1px solid #555; }
    button { padding: 4px 10px; background: #28a745; color: #fff; border: none; cursor: pointer; }
    button:hover { background: #218838; }
    .history { font-size: 0.9em; color: #ccc; margin-top: 4px; }
  </style>
</head>
<body>
  <h2>Canh giờ Boss - Lineage2M</h2>
  <div id="bossTable">Đang tải dữ liệu...</div>

  <script>
    const SHEET_URL = "https://script.google.com/macros/s/AKfycbyo7xVyR5OVsZAx0TB4Ta-H2t-KuNJ7sn1DMqXfJKXN3cqHdngx0MMhYqBnqGHvMcyM/exec";

    async function fetchBossData() {
      const res = await fetch(SHEET_URL);
      const bosses = await res.json();
      renderBossTable(bosses);
    }

    function renderBossTable(bosses) {
      let html = '<table><tr><th>Zone</th><th>Location</th><th>Name</th><th>Level</th><th>Respawn</th><th>Kill Time</th></tr>';
      bosses.forEach(boss => {
        const inputId = `kill-${boss.name}`;
        html += `
          <tr>
            <td>${boss.zone}</td>
            <td>${boss.location}</td>
            <td>${boss.name}</td>
            <td>${boss.level}</td>
            <td>${boss.respawn}</td>
            <td>
              <input type="datetime-local" id="${inputId}">
              <button onclick="submitKillTime('${boss.name}', '${boss.zone}', '${boss.location}', '${inputId}')">Lưu</button>
              <div class="history" id="hist-${boss.name}"></div>
            </td>
          </tr>
        `;
      });
      html += '</table>';
      document.getElementById("bossTable").innerHTML = html;

      bosses.forEach(boss => showHistory(boss.name));
    }

    function submitKillTime(name, zone, location, inputId) {
      const input = document.getElementById(inputId);
      const killTime = new Date(input.value).toISOString();
      if (!killTime) return alert("Chọn thời gian hợp lệ!");

      const data = { name, zone, location, killTime };

      // Gửi POST lên Google Sheet
      fetch(SHEET_URL, {
        method: 'POST',
        body: JSON.stringify(data),
        headers: { 'Content-Type': 'application/json' }
      })
      .then(res => res.text())
      .then(() => {
        saveLocalHistory(name, killTime);
        showHistory(name);
        alert("Đã lưu thời gian tiêu diệt!");
      })
      .catch(err => {
        console.error(err);
        alert("Lỗi khi gửi dữ liệu.");
      });
    }

    function saveLocalHistory(name, time) {
      const key = `history-${name}`;
      let history = JSON.parse(localStorage.getItem(key) || "[]");
      history.unshift(time);
      history = history.slice(0, 5); // chỉ giữ 5 lần gần nhất
      localStorage.setItem(key, JSON.stringify(history));
    }

    function showHistory(name) {
      const key = `history-${name}`;
      let history = JSON.parse(localStorage.getItem(key) || "[]");
      const el = document.getElementById(`hist-${name}`);
      el.innerHTML = "Lịch sử: " + history.map(t => new Date(t).toLocaleString()).join(" | ");
    }

    fetchBossData();
  </script>
</body>
</html>
